/**
 * Menu Preview Functions
 * Men√º ve Mobile Men√º √∂nizleme fonksiyonlarƒ±
 */

// ThemeEditor sƒ±nƒ±fƒ±na men√º fonksiyonlarƒ± ekle
if (typeof ThemeEditor !== 'undefined') {
    
    // Men√º √∂nizleme g√ºncelleme fonksiyonu
    ThemeEditor.prototype.updateMenuPreview = function(formData) {
        console.log('üîß updateMenuPreview called', formData);
        
        // ƒ∞lgili t√ºm men√º CSS deƒüi≈ükenlerini g√ºncelle
        this.updateCSSVariables(formData, [
            'menu-background-color', 'menu-text-color', 'menu-hover-color', 'menu-hover-bg-color',
            'menu-active-color', 'menu-active-bg-color', 'menu-font-size', 'menu-height', 'menu-padding',
            'submenu-bg-color', 'submenu-text-color', 'submenu-hover-color', 'submenu-hover-bg-color',
            'submenu-border-color', 'submenu-width', 'submenu-font-size',
            'mobile-menu-background-color', 'mobile-menu-text-color', 'mobile-menu-hover-color', 'mobile-menu-hover-bg-color',
            'hamburger-icon-color', 'mobile-menu-divider-color', 'mobile-menu-font-size', 'mobile-menu-padding'
        ]);
        
        console.log('‚úÖ Menu preview g√ºncellendi (CSS Deƒüi≈ükenleri aracƒ±lƒ±ƒüƒ±yla)');
    };
    
    // CSS deƒüi≈ükenlerini toplu g√ºncelleme yardƒ±mcƒ±sƒ±
    ThemeEditor.prototype.updateCSSVariables = function(formData, varNames) {
        // G√ºvenlik kontrol√º: varNames tanƒ±msƒ±z veya bir dizi deƒüilse i≈ülemi durdur
        if (!varNames || !Array.isArray(varNames)) {
            // console.warn('updateCSSVariables √ßaƒürƒ±ldƒ± ancak varNames tanƒ±msƒ±z veya dizi deƒüil.');
            return;
        }

        const root = document.documentElement;
        varNames.forEach(varName => {
            if (formData[varName] !== undefined) {
                let value = formData[varName];
                // Sayƒ±sal deƒüerlere birim ekle (eƒüer birimsizse)
                if (this.isNumericVariable(varName) && this.isUnitless(value)) {
                    value += 'px';
                }
                root.style.setProperty(`--${varName}`, value);
            }
        });
    };
    
    // Deƒüi≈ükenin sayƒ±sal olup olmadƒ±ƒüƒ±nƒ± kontrol et
    ThemeEditor.prototype.isNumericVariable = function(varName) {
        return varName.includes('size') || varName.includes('width') || varName.includes('height') || varName.includes('padding');
    };
    
    // Deƒüerin birimsiz olup olmadƒ±ƒüƒ±nƒ± kontrol et
    ThemeEditor.prototype.isUnitless = function(value) {
        return value !== '' && !isNaN(value) && !/px|rem|em|%|vw|vh/.test(value.toString());
    };
    
    // Men√º √∂nizleme toggle fonksiyonlarƒ±
    ThemeEditor.prototype.initMenuPreviewToggle = function() {
        const self = this;
        console.log('üîß initMenuPreviewToggle ba≈ülatƒ±ldƒ±');
        
        // Desktop men√º toggle
        $(document).on('click', '#toggleMenuPreview', function(e) {
            e.preventDefault();
            e.stopPropagation();
            self.toggleMenuPreview('desktop');
        });
        
        // Mobile men√º toggle
        $(document).on('click', '#toggleMobileMenuPreview', function(e) {
            e.preventDefault();
            e.stopPropagation();
            self.toggleMenuPreview('mobile');
        });
        
        // Dual preview a√ßma
        $(document).on('click', '#openMobileMenuDualPreview', function(e) {
            e.preventDefault();
            e.stopPropagation();
            self.openMenuDualPreview();
        });
        
        console.log('‚úÖ Menu preview toggle event listeners eklendi');
    };
    
    ThemeEditor.prototype.toggleMenuPreview = function(type) {
        console.log(`üîÑ toggleMenuPreview √ßaƒürƒ±ldƒ±: ${type}`);
        
        const isDesktop = type === 'desktop';
        const cardId = isDesktop ? '#menu-preview' : '#mobileMenuPreviewCard';
        const iconId = isDesktop ? '#menuPreviewToggleIcon' : '#mobileMenuPreviewToggleIcon';
        const bodyClass = isDesktop ? 'menu-preview-pinned' : 'mobile-menu-preview-pinned';
        const buttonId = isDesktop ? '#toggleMenuPreview' : '#toggleMobileMenuPreview';
        const previewFixedClass = isDesktop ? 'menu-preview-fixed' : 'mobile-menu-preview-fixed';
        
        const $card = $(cardId);
        const $icon = $(iconId);
        const $button = $(buttonId);
        const $body = $('body');
        
        if ($card.length === 0) {
            console.error(`‚ùå ${cardId} elementi bulunamadƒ±!`);
            return;
        }
        
        if ($card.hasClass(previewFixedClass)) {
            console.log('üìç Men√º preview kapatƒ±lƒ±yor...');
            this.unpinMenuPreview(type, $card, $icon, $button, $body, bodyClass, previewFixedClass);
        } else {
            console.log('üìå Men√º preview sabitleniyor...');
            this.pinMenuPreview(type, $card, $icon, $button, $body, bodyClass, previewFixedClass);
        }
    };
    
    ThemeEditor.prototype.pinMenuPreview = function(type, $card, $icon, $button, $body, bodyClass, previewFixedClass) {
        console.log(`üìå Men√º preview sabitleniyor: ${type}`);
        
        // √ñnce mevcut sabit preview'larƒ± kaldƒ±r
        $('.menu-preview-fixed, .mobile-menu-preview-fixed').removeClass('menu-preview-fixed mobile-menu-preview-fixed');
        $('body').removeClass('menu-preview-pinned mobile-menu-preview-pinned');
        $('#menuPreviewToggleIcon, #mobileMenuPreviewToggleIcon').removeClass('fa-compress').addClass('fa-expand');
        $('#toggleMenuPreview, #toggleMobileMenuPreview').removeClass('preview-pinned');
        
        // Yeni preview'ƒ± sabitle
        $card.addClass(previewFixedClass);
        $body.addClass(bodyClass);
        $icon.removeClass('fa-expand').addClass('fa-compress');
        $button.addClass('preview-pinned');
        
        // Sayfayƒ± en √ºste kaydƒ±r
        setTimeout(() => {
            $('html, body').animate({ scrollTop: 0 }, 300);
        }, 100);
        
        this.showNotification(`üìå ${type === 'desktop' ? 'Desktop' : 'Mobil'} men√º √∂nizlemesi sabitlendi`, 'success', 3000);
        console.log(`‚úÖ ${type} men√º preview sabitlendi`);
    };
    
    ThemeEditor.prototype.unpinMenuPreview = function(type, $card, $icon, $button, $body, bodyClass, previewFixedClass) {
        console.log(`üìç Men√º preview kaldƒ±rƒ±lƒ±yor: ${type}`);
        
        $card.addClass('header-preview-removing');
        
        setTimeout(() => {
            $card.removeClass(`${previewFixedClass} header-preview-removing`);
            $body.removeClass(bodyClass);
            $icon.removeClass('fa-compress').addClass('fa-expand');
            $button.removeClass('preview-pinned');
            
            console.log(`‚úÖ ${type} men√º preview kaldƒ±rƒ±ldƒ±`);
        }, 300);
        
        this.showNotification(`üìç ${type === 'desktop' ? 'Desktop' : 'Mobil'} men√º √∂nizlemesi kapatƒ±ldƒ±`, 'info', 2000);
    };
    
    ThemeEditor.prototype.openMenuDualPreview = function() {
        console.log('üîÑ openMenuDualPreview ba≈ülatƒ±ldƒ±');
        
        // Mevcut sabit preview'larƒ± kaldƒ±r
        this.unpinAllPreviews();
        
        // Desktop ve mobil men√º i√ßeriklerini al
        const desktopMenuContent = $('#menu-preview').prop('outerHTML');
        const mobileMenuContent = $('#mobileMenuPreview').prop('outerHTML');
        
        const dualPreviewHTML = `
            <div class="dual-menu-preview-container">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center p-3">
                                <h5 class="mb-0">
                                    <i class="fa fa-window-restore text-primary"></i>
                                    Dual Men√º √ñnizlemesi
                                </h5>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="closeDualMenuPreview">
                                    <i class="fa fa-times"></i> Kapat
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card dual-preview-desktop h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fa fa-desktop"></i> Desktop Men√º</h6>
                                </div>
                                <div class="card-body">${desktopMenuContent}</div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card dual-preview-mobile h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fa fa-mobile"></i> Mobile Men√º</h6>
                                </div>
                                <div class="card-body">${mobileMenuContent}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('body').append(dualPreviewHTML);
        $('body').addClass('dual-menu-preview-active');
        
        // Kapatma event'lerini ekle
        $(document).on('click', '#closeDualMenuPreview', () => this.closeDualMenuPreview());
        $(document).on('keydown.dualmenupreview', (e) => {
            if (e.keyCode === 27) this.closeDualMenuPreview(); // ESC
        });
        
        setTimeout(() => $('html, body').animate({ scrollTop: 0 }, 300), 100);
        this.showNotification('üîÑ Dual Menu Preview: Desktop ve Mobile yan yana g√∂r√ºnt√ºleniyor', 'success', 3000);
        console.log('‚úÖ Dual menu preview a√ßƒ±ldƒ±');
    };
    
    ThemeEditor.prototype.closeDualMenuPreview = function() {
        console.log('üîÑ closeDualMenuPreview ba≈ülatƒ±ldƒ±');
        const $container = $('.dual-menu-preview-container');
        
        $container.addClass('header-preview-removing');
        
        setTimeout(() => {
            $container.remove();
            $('body').removeClass('dual-menu-preview-active');
            $(document).off('.dualmenupreview');
            console.log('‚úÖ Dual menu preview kapatƒ±ldƒ±');
        }, 300);
        
        this.showNotification('üìç Dual Menu Preview kapatƒ±ldƒ±', 'info', 2000);
    };
    
    ThemeEditor.prototype.unpinAllPreviews = function() {
        $('.menu-preview-fixed, .mobile-menu-preview-fixed').removeClass('menu-preview-fixed mobile-menu-preview-fixed');
        $('body').removeClass('menu-preview-pinned mobile-menu-preview-pinned');
        $('#menuPreviewToggleIcon, #mobileMenuPreviewToggleIcon').removeClass('fa-compress').addClass('fa-expand');
        $('#toggleMenuPreview, #toggleMobileMenuPreview').removeClass('preview-pinned');
    };

} else {
    console.error('‚ùå menu.js: ThemeEditor sƒ±nƒ±fƒ± bulunamadƒ±! core.js y√ºklenmi≈ü mi?');
}

console.log('‚úÖ Menu.js y√ºklendi - Men√º √∂nizleme sistemleri hazƒ±r');
